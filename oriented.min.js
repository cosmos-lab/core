"use strict";const Orns=(e,t,r)=>{const n=new OrnCollection(e),i=n.get();if(!i)return void(Orn.debug&&console.log(`ORN: Container not found for selector "${e}"`,t,e));i.scope=new Proxy(t,OrnProxy);const a=(r=new OrnTemplate(void 0!==r?r:n.get())).ProcesS();for(;n.get().firstChild;)n.get().removeChild(n.get().firstChild);a.map(e=>{let r=t instanceof Array?t:[t];OrnParser.Output(OrnParser.Process(OrnParser.Clone(e),!1,0,r),n.get(),void 0!==t.svg)});for(var s=n.find("orn-component"),o=0;o<s.length;o++){let e=new OrnCollection(s[o]);if(void 0===e._Loaded){var l=new(new Function([],"return "+e.get().identifier)())(e.get(),e.get().shared);e.get().component=l,void 0!==l.Init&&l.Init(),e._Loaded=!0}}return n},Orn=async(e,t,r)=>{const n=new OrnCollection(e),i=n.get();if(!i)return void(Orn.debug&&console.log(`ORN: Container not found for selector "${e}"`,t,e));i.scope=new Proxy(t,OrnProxy),r=new OrnTemplate(void 0!==r?r:n.get());const a=await r.Process();for(;n.get().firstChild;)n.get().removeChild(n.get().firstChild);a.map(e=>{let r=t instanceof Array?t:[t];var i=OrnParser.Process(OrnParser.Clone(e),!1,0,r);OrnParser.Output(i,n.get(),void 0!==t.svg)});for(var s=n.find("orn-component"),o=0;o<s.length;o++){let e=new OrnCollection(s[o]);if(void 0===e._Loaded){e.attr("src")&&(await Orn.Include(e.attr("src")),e.attr("src",!1,!0));var l=new(new Function([],"return "+e.get().identifier)())(e.get(),e.get().shared);e.get().component=l,void 0!==l.Init&&await l.Init(),e._Loaded=!0}}for(s=n.find("orn-template"),o=0;o<s.length;o++){let e=s[o],r=e.getAttribute("src");if(r){if(!e._Loaded){var c=e.shared;await Orn(e,[t,c],r),e._Loaded=!0}}else Orn.debug&&console.log("ORN: Template src not found:",e)}return n},OrnVoice={dispose:function(){},Get:(e,t)=>{Selector(e).css("orn-voice-input-active",!0);try{var r=r||webkitSpeechRecognition,n=new r;n.continuous=!1,n.interimResults=!1,n.lang="en-US",n.start(),n.onspeechend=()=>{n.stop(),Selector(e).css("orn-voice-input-active",!1)},n.onresult=e=>{for(var r=e.resultIndex;r<e.results.length;++r){var n=e.results[r][0].transcript.trim();e.results[r].isFinal&&t(n)}}}catch(e){}}},OrnProxy={get(e,t){if("isProxy"==t)return!0;if(e[t]instanceof Array){var r=[];return e[t].forEach(e=>{var t=new Proxy(e,OrnProxy);r.push(t)}),e[t]=r,e[t]}return"object"!=typeof e[t]||e[t].isProxy||null===e[t]?e[t]:new Proxy(e[t],OrnProxy)},set(e,t,r){e[t]=r,(n=Selector("input, textarea, select")).each(n=>{void 0!==n.__listen&&e==n.__listen.target&&t==n.__listen.key&&(n.value=r)});for(var n=OrnTemplate.TextNodes(document.body),i=0;i<n.length;i++){var a=n[i];void 0!==a.__listen&&-1!=a.__listen.keys.indexOf(t)&&a.__listen.target()}return!0}};Orn.Include=async e=>{if(Orn.Include.queue||(Orn.Include.queue={}),"string"==typeof e){var t=e;if(t.match(/\.css/)){if(!document.querySelector('link[href="'+t+'"]')){const e=document.createElement("link");e.type="text/css",e.rel="stylesheet",e.href=t,new OrnCollection("head").append(e)}}else{var r=document.querySelector('script[src="'+t+'"]');r?await new Promise((e,n)=>{Orn.Sleep((function(){return void 0===Orn.Include.queue[t]?(e(),!0):"ERROR"==Orn.Include.queue[t]&&(n(),r.parentNode.removeChild(r),!0)}))}):await new Promise((e,r)=>{Orn.Include.queue[t]=!0;const n=document.createElement("script");n.onload=function(){delete Orn.Include.queue[t],e()},n.onerror=function(){Orn.Include.queue[t]="ERROR",r()},n.async=!0,document.body.appendChild(n),n.src=t})}}else for(var n=0;n<e.length;n++)await Orn.Include(e[n])},Orn.Sleep=e=>{e()||setTimeout((function(){Orn.Sleep(e)}))};class OrnTemplate{constructor(e){this.template=e}async Process(){return this.IsElement()?this.Parse(this.template).children:this.IsURL()?await this.LoadHTML():this.VDOM(this.template)}async LoadHTML(){const e=this.template;if(void 0===OrnTemplate.cache[e]){OrnTemplate.cache[e]=!0;var t=await fetch(e,{cache:"force-cache"});if(!t.ok)throw Error(e+" not found or internet connection error.");t=await t.text(),OrnTemplate.cache[e]=this.VDOM(t)}return!0===OrnTemplate.cache[e]&&await new Promise((t,r)=>{Orn.Sleep((function(){return!0!==OrnTemplate.cache[e]&&(t(),!0)}))}),OrnTemplate.cache[e]}ProcesS(){return this.IsElement()?this.Parse(this.template).children:this.VDOM(this.template)}IsURL(){return!this.template.match(/(\<.*\>)|\n/gi)}IsElement(){return"string"!=typeof this.template}VDOM(e){let t=document.createElement("div");return t.innerHTML=e,this.Parse(t).children}Parse(e,t){var r={tag:e.nodeName.toLowerCase(),attributes:[]};if("#comment"!=r.tag){if("option"==r.tag&&(r.html=e.text),"#text"==r.tag)return r.text=e.textContent,r;if("style"==r.tag)return document.body.append(e),r;for(var n=0;n<e.attributes.length;n++){var i=e.attributes[n];if(r.attributes.push({name:i.name,value:i.value}),"orn-module"==i.name&&!t){var a=i.value;if(OrnTemplate.cache[a])return OrnTemplate.cache[a];OrnTemplate.cache[a]=this.Parse(e,!0)}}if("orn-component"==r.tag&&!t){let t=e.getAttribute("identifier");if(t&&!e.getAttribute("src")&&!e.getAttribute("orn-src"))return OrnTemplate.cache[t]||(OrnTemplate.cache[t]=this.Parse(e,!0)),OrnTemplate.cache[t]}r.children=[];for(var s=0;s<e.childNodes.length;s++){var o=e.childNodes[s];if("orn-component"!=o.nodeName.toLowerCase()||o.getAttribute("src")||o.getAttribute("orn-src"))l=this.Parse(o);else{let e=o.getAttribute("identifier");OrnTemplate.cache[e]||(OrnTemplate.cache[e]=this.Parse(o));var l={tag:OrnTemplate.cache[e].tag,attributes:OrnTemplate.cache[e].attributes}}r.children.push(l)}return r}}static TextNodes(e){var t=[];for(e=e.firstChild;e;e=e.nextSibling)3==e.nodeType?t.push(e):t=t.concat(OrnTemplate.TextNodes(e));return t}}class OrnCollection extends Array{constructor(e,t){super(),!t||t instanceof Array||(t=[t]),t=t||[document];for(let i=0;i<t.length;i++){var r=[];if(e instanceof Array)r=e;else if("object"==typeof e)r=[e];else if(e){var n=e.split(",");for(let e=0;e<n.length;e++)r=r.concat(Array.from(t[i].querySelectorAll(n[e])))}for(let e=0;e<r.length;e++)this.push(r[e])}}get(e){return!!this.length&&this[e||0]}parent(){return new OrnCollection(!!this.length&&this[0].parentNode)}first(){return new OrnCollection(this[0])}last(){return new OrnCollection(this[this.length-1])}next(){return new OrnCollection(this[0].nextSibling)}prev(){return new OrnCollection(this[0].previousSibling)}siblings(e){e=e||"*";var t=this,r=new OrnCollection(Array.from(this.length&&this.get().parentNode?this.get().parentNode.children:[]));return r.filter((function(r){return r!=t.get()&&r.matches(e)}))}empty(){return this.forEach(e=>{for(;e.firstChild;)e.removeChild(e.firstChild)}),this}remove(){this.forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)})}css(e,t){if(void 0===t)return this.length&&this.get().classList.contains(e);const r=e.split(" ");return!1===t?(this.forEach(e=>{r.forEach(t=>{e.classList.remove(t)})}),this):(this.forEach(e=>{r.forEach(t=>{e.classList.add(t)})}),this)}style(e,t){return void 0===t?this.get().style.getPropertyValue(e):(this.forEach(r=>{!1===t&&r.style.removeProperty(e),r.style.setProperty(e,t)}),this)}toggle(e,t){return void 0!==t?this.forEach(r=>{r.innerHTML=r.innerHTML==t?e:t}):this.forEach(t=>{t.classList.toggle(e)}),this}hide(){return this.forEach(e=>{e.style.display="none"}),this}show(){return this.forEach(e=>{e.style.removeProperty("display")}),this}append(e,t){return this.forEach(r=>{if("string"==typeof e){var n=document.createElement("div");n.innerHTML=e.trim(),e=n.firstElementChild}void 0!==t&&r.firstChild?r.insertBefore(e,r.firstElementChild):r.append(e)}),this}html(e){return void 0===e?this.length?this.get().innerHTML:"":(this.forEach(t=>{t.innerHTML=e}),this)}find(e){return new OrnCollection(e,this)}attr(e,t,r){return t||r?(this.forEach(n=>{r?n.removeAttribute(e,t):n.setAttribute(e,t)}),this):this.get().getAttribute(e)}each(e){return this.forEach(t=>{e.call(t,t)}),this}event(e,t){return t?(this.forEach(r=>{r.addEventListener(e,e=>{t.call(r,e)})}),this):(this.forEach(t=>{var r=document.createEvent("HTMLEvents");r.initEvent(e,!0,!0),t.dispatchEvent(r)}),this)}delegate(e,t,r,n){this.each(i=>{i.addEventListener(t,t=>{for(var n=new OrnCollection(e),i=!1,a=t.target;a;)n.each(e=>{a==e&&(i=a,t.stopPropagation())}),a=a.parentNode;i&&r.call(i,t)},void 0!==n)})}offset(e){var t=this.get();return{width:t.offsetWidth,height:t.offsetHeight,left:t.offsetLeft,top:t.offsetTop}}children(e){var t=[];return this.each(e=>{t=t.concat(Array.from(e.children))}),new OrnCollection(t)}ancestor(e,t){let r=new OrnCollection(e).get();t||(t=this.get());var n=t.parentNode;return!(!n||n==document.body)&&(r==n?n:this.ancestor(e,n))}}class OrnParser{constructor(e,t,r,n,i){this.scope=i,this.node=e,this.parent=t,this.index=r,this.attribute=n}static Clone(e){var t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return(t=new Date).setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var r=0,n=e.length;r<n;r++)t[r]=OrnParser.Clone(e[r]);return t}if(e instanceof Object){for(var i in t={},e)e.hasOwnProperty(i)&&(t[i]=OrnParser.Clone(e[i]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}static Process(e,t,r,n){if(void 0===r&&(r=0),!e||!e.tag)return void(Orn.debug&&console.log("ORN: Invalid HTML tag",arguments));const i=e.tag;if("#comment"===i)return e;if("#text"===i){var a=e.text.match(/\{\{(.*?)\}\}/gi);if(null!==a){u=new OrnParser(e,t,r,!1,n);for(var s=[],o=[],l=0;l<a.length;l++){let t=a[l].replace(/\{\{|\}\}/gi,"");s.push(t);let r=u.Parse(t);e.text=e.text.replace(a[l],r);let n=t.split(".");o.push(n[n.length-1])}e.__listen=((e,t)=>r=>{r.__listen={keys:o,target:()=>{for(var n="",i=0;i<t.length;i++)n+=" "+e.Parse(t[i]);r.textContent=n}}})(u,s)}return e}var c=!1;const h=e.attributes.find(e=>"orn-repeat"==e.name);if(!h){for(let i=0;i<e.attributes.length;i++){let a=e.attributes[i];if(/^orn-/.test(a.name)&&!c){a.index=i;var u=new OrnParser(e,t,r,a,n);switch(!0){case"orn-module"===a.name:break;case/^orn-on/.test(a.name):u.OnEvent();break;case"orn-show"===a.name:u.Show();break;case"orn-model"===a.name:u.InputModel();break;case"orn-class"===a.name:u.CSSClass();break;case"orn-style"===a.name:u.CSSStyle();break;case"orn-if"===a.name:u.Condition()||(c=!0);break;case"orn-checked"===a.name||"orn-selected"===a.name||"orn-disabled"===a.name:u.InputState();break;default:u.Attribute()}}}if(e.children&&e.children.length)for(let t in e.children){var d=e.children[t];OrnParser.Process(d,e,t,n)}return e}h.index=e.attributes.indexOf(h),new OrnParser(e,t,r,h,n).Repeat()}static Output(e,t,r){if(e&&e.tag){if(!e.text){if(r)n=document.createElementNS("http://www.w3.org/2000/svg",e.tag);else var n=document.createElement(e.tag);if(e.html){var i=e.html;"function"==typeof e.html&&(i=e.html(n)),n.innerHTML=i}void 0!==e.__listen&&e.__listen(n);for(var a=0;a<e.attributes.length;a++){var s=e.attributes[a];void 0!==s.value&&(s.name[0]+s.name[1]==="on"?n.addEventListener(s.name.replace("on",""),function(e){return function(t){this.model&&this.model(t),"string"!=typeof e?e(t,n):new Function("a",e).call(this,t,n)}}(s.value)):"value"===s.name?n.value=s.value:"model"===s.name?(n.model=function(e){return function(t){this.event=t,"string"!=typeof e?e(this):new Function("a",e).call(this)}}(s.value),function(e,t){t.addEventListener("change",(function(e){this.model(e)})),t.addEventListener("keyup",(function(e){this.model(e)}))}(s.value,n)):"show"===s.name?(n.show=function(e){return function(){"string"!=typeof e?e(this):new Function("a",e).call(this)}}(s.value),n.setAttribute("orn-show","")):null!==s.value&&("function"==typeof s.value&&(s.value=s.value(n)),"object"!=typeof s.value&&"identifier"!=s.name||new Function(["value"],`this.${s.name} = value`).call(n,s.value),n.setAttribute(s.name,s.value)))}if(e.children)for(var o=0;o<e.children.length;o++)n.isOption="option"==e.tag,OrnParser.Output(e.children[o],n,r);return null!==e.position&&void 0!==e.position?t.insertBefore(n,t.childNodes[e.position]):t.appendChild(n),n}var l=e.text;if("function"==typeof e.text&&(l=e.text(n)),t.isOption)t.text=l;else{n=document.createTextNode(l);t.appendChild(n),void 0!==e.__listen&&e.__listen(n)}}}Parse(e){var t=e;const r=this.Args();try{t=new Function(r.arg,"return "+e).apply(this.scope[0],r.val)}catch(r){t=null,Orn.debug&&console.log(`ORN: Expression "${e}" not found in scope`,this.scope)}return t}Args(){const e={arg:[],val:[]};for(let t in this.scope)for(let r in this.scope[t])e.arg.push(r),e.val.push(this.scope[t][r]);return e.arg.push("event"),e.arg.push("element"),e.val.push(!1),e.val.push(!1),e}Repeat(){let e=this.attribute.value.split(" as "),t=this.Parse(e[0].replace(/ \n\t\r/gi,""));if(!t)return;e=e[1].replace(/ \n\t\r/gi,"").split(":");const r=e[0],n=e[1];var i=0;this.parent||console.log("orn-repeat must be in a container",this.attribute.value),this.parent.children[this.index]=!1;for(let e in t){if(!t.hasOwnProperty(e))return;var a=OrnParser.Clone(this.node);a.attributes.splice(this.attribute.index,1);let s={};s[r]=isNaN(e)?e:1*e,s[n]=t[e];let o=[...this.scope,s],l=OrnParser.Process(a,this.parent,0,o);l.position=1*this.index+i++,this.parent.children.push(l)}}Data(){let e=this.Parse(this.attribute.value);"object"==typeof e&&(e=JSON.stringify(e)),this.node.attributes[this.attribute.index]={name:this.attribute.name.replace("orn-",""),value:e}}OnEvent(){const e=this.Args();var t,r,n,i,a=this.attribute.value;if(a.match(/([a-xA-z]+[a-zA-z0-9_]*)\((.*?)\)/gi))try{let r=a.replace(/\((.*?)\)/gi,"");t=new Function(e.arg,`\n                            try{ \n                                return typeof this.${r}!='undefined' ? this.${a} : ${a}\n                            }catch(e){\n                                try{\n                                    return ${a};\n                                }catch(e){\n                                    \n                                }\n                            }\n                    `)}catch(e){return void(Orn.debug&&console.log(`ORN: orn-on expression "${a}" not found in provided scope:`,this.scope))}else t=new Function(e.arg,"return "+a.replace(/\n/g,""));this.node.attributes[this.attribute.index]={name:this.attribute.name.replace("orn-",""),value:(r=t,n=e.val,i=this,function(e,t){n[n.length-2]=e,n[n.length-1]=t,r.apply(i.scope[0],n)})}}Show(){var e,t;this.node.attributes[this.attribute.index]={name:"show",value:(e=this,t=this.attribute.value,function(r){var n=!1;try{n=new Function(["o"],"return o."+t)(e.scope[0])}catch(r){n=e.Parse(t)}n?r.style.removeProperty("display"):r.style.display="none"})}}InputModel(){var e=this.node.attributes.find(e=>"type"===e.name);this.node.attributes[this.attribute.index]={name:"model",value:((t,r)=>{var n=t.Parse(r);return i=>{switch(!0){case e&&("checkbox"==e.value||"radio"==e.value):if(n instanceof Array){var a=-1===n.indexOf(i.value);i.checked?a&&n.push(i.value):!a&&n.splice(n.indexOf(i.value),1)}else i.checked?n=i.value:"radio"!==i.type&&(n="");break;case"SELECT"===t.node.tag:if(i.multiple){n=[];for(var s=0;s<i.options.length;s++){var o=i.options[s];o.selected&&n.push(o.value||o.text)}}else n=i.value;break;default:n instanceof Array?-1===n.indexOf(i.value)&&n.push(i.value):n=i.value}var l=r.split("."),c=l.slice(0,l.length-1).join("."),h=l[l.length-1];return c=c.length?this.Parse(""+c):this.scope[0],new Proxy(c,OrnProxy)[h]=n,r}})(this,this.attribute.value)}}InputState(){this.Parse(this.attribute.value)&&(this.node.attributes[this.attribute.index]={name:this.attribute.name.replace("orn-",""),value:!0})}CSSClass(){var e=this.node.attributes.find(e=>"class"===e.name);e||(e={name:"class",value:""},this.node.attributes.push(e));var t=this.Parse(this.attribute.value);if(delete this.attribute.value,"string"==typeof t)e.value+=" "+t;else if("object"==typeof t)for(let r in t)t[r]&&(e.value+=" "+r);else"function"==typeof t&&(e.value+=" "+t(this.scope))}CSSStyle(){var e=this.node.attributes.find(e=>"style"===e.name);e||(e={name:"style",value:""},this.node.attributes.push(e));var t=this.Parse(this.attribute.value);if(delete this.attribute.value,"string"==typeof t)e.value+=";"+t;else if("object"==typeof t)for(let r in t)t[r]&&(e.value+=";"+r)}Condition(){var e=this.Parse(this.attribute.value);return delete this.attribute.value,!!e||(this.node.tag=!1,this.node.children=[],this.parent&&(this.parent.children[this.index]=!1),!1)}Attribute(){if("orn-value"===this.attribute.name){if("TEXTAREA"===this.node.tag)this.node.html=this.Parse(this.attribute.value);else{let e=this.Parse(this.attribute.value);this.node.attributes[this.attribute.index]={name:this.attribute.name.replace("orn-",""),value:e||""}}var e=this.attribute.value.split("."),t=e.slice(0,e.length-1).join(".");const n=this.Args();try{t=new Function(n.arg,"return "+t).apply(this.scope[0],n.val)}catch(e){}return t||(t=this.scope[0]),void(this.node.__listen=(r=t,t=>{t.__listen={key:e[e.length-1],target:r}}))}var r;let n=this.Parse(this.attribute.value);this.node.attributes[this.attribute.index]={name:this.attribute.name.replace("orn-",""),value:n||""}}}class FetchWrapper{constructor(e,t,r){void 0===t&&(t={}),void 0===r&&(r={}),r.noerror&&(this.noerror=!0),this.url=e,this.config={headers:{},credentials:"same-origin"},"undefined"!=typeof AbortController&&(this.controller=new AbortController,this.config.signal=this.controller.signal),r.post?(this.config.method="POST",this.config.body=Fetch.FD(t)):this.url=`${this.url}${-1==this.url.indexOf("?")?"?":"&"}${Fetch.QS(t)}`,r.offline&&(this.config.headers.offline=!0),r.persist&&(this.config.headers.persist=!0)}Abort(){this.controller&&this.controller.abort()}async Load(){var e=!1;try{if(!(e=await fetch(this.url,this.config)).ok)throw Error();e="application/json"==e.headers.get("content-type")?await e.json():await e.text()}catch(e){}return e}}var Selector=e=>new OrnCollection(e),Fetch=(e,t,r)=>new FetchWrapper(e,t,r);Fetch.QS=(e,t,r)=>{if(void 0===r&&(r=[]),!e||"object"!=typeof e||e instanceof Date||e instanceof File){const n=null==e?"":e;r.push(`${t}=${n}`)}else Object.keys(e).forEach(n=>{Fetch.QS(e[n],t?`${t}[${n}]`:n,r)});return t||(r=r.join("&")),r},Fetch.FD=(e,t,r)=>{if(void 0===r&&(r=new FormData),!e||"object"!=typeof e||e instanceof Date||e instanceof File){const n=null==e?"":e;r.append(t,n)}else Object.keys(e).forEach(n=>{Fetch.FD(e[n],t?`${t}[${n}]`:n,r)});return r},(()=>{OrnTemplate.cache={},Orn.debug=!1,OrnTemplate.cache={},setInterval((function(){let e=document.querySelectorAll('*[orn-show=""]');if(e)for(let t=0;t<e.length;t++)e[t].show&&e[t].show()}),50);try{document.createEvent("TouchEvent"),Orn.touch={}}catch(e){Orn.touch=!1}Selector("body").delegate(".orn-touch-listener","touchstart",(function(e){Orn.touch.moved=0,Orn.touch.starter=[],Orn.touch.started=[];for(var t=0;t<e.touches.length;t++){var r=e.touches[t];Orn.touch.starter.push({el:document.elementFromPoint(r.clientX,r.clientY)}),Orn.touch.started.push({x:r.clientX,y:r.clientY})}})),Selector("body").delegate(".orn-touch-listener","touchmove",(function(e){var t=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);t.dispatchEvent(new CustomEvent("touchover",{detail:{target:t}}))})),Selector("body").delegate(".orn-touch-listener","touchend",(function(e){var t=e.changedTouches[0].clientX-Orn.touch.started[0].x;e.changedTouches[0].clientY,Orn.touch.started[0].y,t>0&&this.dispatchEvent(new CustomEvent("touchmoveright",{detail:{target:this}})),t<0&&this.dispatchEvent(new CustomEvent("touchmoveleft",{detail:{target:this}}))}))})();